fhir-server:
  image: ghcr.io/dot-base/fhir-server:next
  environment:
    HAPI_SERVER_ADDRESS: "https://${HOSTNAME}/api/fhir/"
    HAPI_DATASOURCE_URL: "jdbc:postgresql://fhir-db:5432/hapi_r4"
    HAPI_DATASOURCE_USERNAME: ${FHIR_DB_USER}
    HAPI_DATASOURCE_PASSWORD: ${FHIR_DB_PASSWORD}
    SENTRY_DSN: ${FHIR_SERVER_SENTRY_DSN}
    SENTRY_ENVIRONMENT: ${SENTRY_ENVIRONMENT}
  networks:
    - proxy
    - fhir
  deploy:
    replicas: 1
    update_config:
      parallelism: 2
      delay: 60s
    restart_policy:
      condition: on-failure
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.fhir.tls=true"
      - "traefik.http.routers.fhir.middlewares=sso"
      - "traefik.http.routers.fhir.rule=Host(`${HOSTNAME}`) && PathPrefix(`/api/fhir`)"
      - "traefik.http.services.fhir.loadbalancer.server.port=8080"

fhir-db:
  image: postgres:13-alpine
  environment:
    POSTGRES_DB: "hapi_r4"
    POSTGRES_USER: ${FHIR_DB_USER}
    POSTGRES_PASSWORD: ${FHIR_DB_PASSWORD}
  networks:
    - fhir
  volumes:
    - fhir-data:/var/lib/postgresql/data
  deploy:
    placement:
      max_replicas_per_node: 1
